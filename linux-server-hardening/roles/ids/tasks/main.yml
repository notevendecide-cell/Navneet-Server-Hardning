---
# Role: ids (intrusion detection/prevention)
# Configure Fail2Ban to protect SSH

- name: Ensure fail2ban is installed (Ubuntu)
  apt:
    name: fail2ban
    state: present
    update_cache: yes
  when: ansible_facts['os_family'] == 'Debian'

- name: Ensure fail2ban is installed (SUSE)
  zypper:
    name: fail2ban
    state: present
  when: ansible_facts['os_family'] == 'Suse'

- name: Configure fail2ban (Ubuntu with UFW)
  copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      backend = systemd
      bantime = 10m
      findtime = 10m
      maxretry = 5
      banaction = ufw

      [sshd]
      enabled = true
    owner: root
    group: root
    mode: '0644'
  when: ansible_facts['os_family'] == 'Debian'
  notify: Restart fail2ban

- name: Configure fail2ban (SUSE with firewalld)
  copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      backend = systemd
      bantime = 10m
      findtime = 10m
      maxretry = 5
      banaction = firewallcmd-ipset

      [sshd]
      enabled = true
    owner: root
    group: root
    mode: '0644'
  when: ansible_facts['os_family'] == 'Suse'
  notify: Restart fail2ban

- name: Enable and start fail2ban
  service:
    name: fail2ban
    state: started
    enabled: yes
  when: not ansible_check_mode
